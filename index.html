import React, { useState, useEffect } from 'react';
import { Plus, Minus, Trash2, X } from 'lucide-react';

export default function MultiCounterApp() {
  const [counters, setCounters] = useState([]);
  const [newCounterName, setNewCounterName] = useState('');
  const [showModal, setShowModal] = useState(null);

  // Load counters from memory on mount
  useEffect(() => {
    const loadCounters = async () => {
      try {
        const result = await window.storage.list('counter:');
        if (result && result.keys) {
          const loadedCounters = await Promise.all(
            result.keys.map(async (key) => {
              try {
                const data = await window.storage.get(key);
                return data ? JSON.parse(data.value) : null;
              } catch {
                return null;
              }
            })
          );
          setCounters(loadedCounters.filter(Boolean));
        }
      } catch (error) {
        console.log('No saved counters found');
      }
    };
    loadCounters();
  }, []);

  // Save counter whenever it changes
  const saveCounter = async (counter) => {
    try {
      await window.storage.set(`counter:${counter.id}`, JSON.stringify(counter));
    } catch (error) {
      console.error('Failed to save counter:', error);
    }
  };

  // Check and reset counters based on their reset period
  useEffect(() => {
    const checkResets = () => {
      const now = Date.now();
      setCounters(prev => {
        const updated = prev.map(counter => {
          if (!counter.autoReset || !counter.lastReset) return counter;
          
          const timeSinceReset = now - counter.lastReset;
          const resetInterval = {
            'day': 24 * 60 * 60 * 1000,
            'week': 7 * 24 * 60 * 60 * 1000,
            'month': 30 * 24 * 60 * 60 * 1000,
            'year': 365 * 24 * 60 * 60 * 1000
          }[counter.autoReset];

          if (timeSinceReset >= resetInterval) {
            const resetCounter = { ...counter, count: 0, lastReset: now };
            saveCounter(resetCounter);
            return resetCounter;
          }
          return counter;
        });
        return updated;
      });
    };

    const interval = setInterval(checkResets, 60000); // Check every minute
    checkResets(); // Check immediately
    return () => clearInterval(interval);
  }, [counters]);

  const addCounter = () => {
    if (newCounterName.trim()) {
      const newCounter = {
        id: Date.now(),
        name: newCounterName.trim(),
        count: 0,
        totalEver: 0,
        createdAt: Date.now(),
        autoReset: null,
        lastReset: null
      };
      setCounters([...counters, newCounter]);
      saveCounter(newCounter);
      setNewCounterName('');
    }
  };

  const updateCount = (id, delta) => {
    setCounters(prev => prev.map(counter => {
      if (counter.id === id) {
        const newCount = Math.max(0, counter.count + delta);
        const newTotalEver = delta > 0 ? counter.totalEver + delta : counter.totalEver;
        const updated = { ...counter, count: newCount, totalEver: newTotalEver };
        saveCounter(updated);
        return updated;
      }
      return counter;
    }));
  };

  const deleteCounter = async (id) => {
    try {
      await window.storage.delete(`counter:${id}`);
      setCounters(counters.filter(counter => counter.id !== id));
    } catch (error) {
      console.error('Failed to delete counter:', error);
    }
  };

  const resetCounter = (id) => {
    setCounters(prev => prev.map(counter => {
      if (counter.id === id) {
        const updated = { ...counter, count: 0 };
        saveCounter(updated);
        return updated;
      }
      return counter;
    }));
  };

  const setAutoReset = (id, period) => {
    setCounters(prev => prev.map(counter => {
      if (counter.id === id) {
        const updated = { 
          ...counter, 
          autoReset: period,
          lastReset: period ? Date.now() : null
        };
        saveCounter(updated);
        return updated;
      }
      return counter;
    }));
    setShowModal(null);
  };

  const formatTimeSince = (timestamp) => {
    const days = Math.floor((Date.now() - timestamp) / (1000 * 60 * 60 * 24));
    if (days === 0) return 'Today';
    if (days === 1) return '1 day ago';
    if (days < 30) return `${days} days ago`;
    if (days < 365) return `${Math.floor(days / 30)} months ago`;
    return `${Math.floor(days / 365)} years ago`;
  };

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 p-4 md:p-8">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-light text-center mb-8 text-gray-100">
          Counters
        </h1>

        {/* Add Counter */}
        <div className="mb-8 max-w-md mx-auto">
          <div className="flex gap-2">
            <input
              type="text"
              value={newCounterName}
              onChange={(e) => setNewCounterName(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addCounter()}
              placeholder="Counter name..."
              className="flex-1 px-4 py-2 bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-gray-600 text-gray-100 placeholder-gray-500"
            />
            <button
              onClick={addCounter}
              className="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded transition-colors"
            >
              Add
            </button>
          </div>
        </div>

        {/* Counters Grid */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {counters.map(counter => (
            <div
              key={counter.id}
              className="bg-gray-800 border border-gray-700 rounded-lg p-6"
            >
              <div className="flex justify-between items-start mb-6">
                <div className="flex-1">
                  <h3 className="text-lg font-medium text-gray-100 mb-1">
                    {counter.name}
                  </h3>
                  <p className="text-xs text-gray-500">
                    {formatTimeSince(counter.createdAt)}
                  </p>
                </div>
                <button
                  onClick={() => deleteCounter(counter.id)}
                  className="text-gray-500 hover:text-gray-300 transition-colors"
                >
                  <Trash2 size={16} />
                </button>
              </div>

              <div className="text-center mb-6">
                <div className="text-6xl font-light text-gray-100 mb-3">
                  {counter.count}
                </div>
                <div className="text-sm text-gray-500">
                  Total: {counter.totalEver}
                </div>
                {counter.autoReset && (
                  <div className="text-xs text-blue-400 mt-1">
                    Resets every {counter.autoReset}
                  </div>
                )}
              </div>

              <div className="flex gap-2 mb-3">
                <button
                  onClick={() => updateCount(counter.id, -1)}
                  className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors flex items-center justify-center"
                >
                  <Minus size={20} />
                </button>
                <button
                  onClick={() => updateCount(counter.id, 1)}
                  className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors flex items-center justify-center"
                >
                  <Plus size={20} />
                </button>
              </div>

              <div className="flex gap-2 text-sm">
                <button
                  onClick={() => resetCounter(counter.id)}
                  className="flex-1 py-2 text-gray-400 hover:text-gray-200 transition-colors"
                >
                  Reset
                </button>
                <button
                  onClick={() => setShowModal(counter.id)}
                  className="flex-1 py-2 text-gray-400 hover:text-gray-200 transition-colors"
                >
                  Auto-reset
                </button>
              </div>
            </div>
          ))}
        </div>

        {counters.length === 0 && (
          <div className="text-center text-gray-500 mt-12">
            <p>No counters yet. Create your first one above.</p>
          </div>
        )}

        {/* Auto-Reset Modal */}
        {showModal && (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-gray-800 border border-gray-700 rounded-lg p-6 max-w-sm w-full">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-medium">Auto-Reset Period</h3>
                <button
                  onClick={() => setShowModal(null)}
                  className="text-gray-500 hover:text-gray-300"
                >
                  <X size={20} />
                </button>
              </div>
              
              <div className="space-y-2 mb-4">
                {[
                  { value: 'day', label: 'Every Day' },
                  { value: 'week', label: 'Every Week' },
                  { value: 'month', label: 'Every Month' },
                  { value: 'year', label: 'Every Year' }
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => setAutoReset(showModal, option.value)}
                    className="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors text-left px-4"
                  >
                    {option.label}
                  </button>
                ))}
              </div>

              <button
                onClick={() => setAutoReset(showModal, null)}
                className="w-full py-2 text-gray-400 hover:text-gray-200 transition-colors"
              >
                Disable Auto-Reset
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
